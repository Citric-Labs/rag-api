import os
import datetime
from pymongo import MongoClient

from dotenv import load_dotenv

load_dotenv()

# connect to your Atlas cluster
client = MongoClient(os.getenv("MONGO_URI"))
db_name = os.getenv("DB_NAME")
collection_name = os.getenv("COLL_NAME")
collection = client[db_name][collection_name]

vector = [-0.08366768062114716, 0.07473519444465637, 0.0030763421673327684, 0.056731775403022766, -0.035887572914361954,
          -0.05119839683175087, 0.053834304213523865, 0.0012465913314372301, 0.0369148924946785, 0.03396691754460335,
          -0.025947492569684982, -0.04153433442115784, -0.04643571004271507, 0.01834130845963955, -0.08885408192873001,
          -0.002022059401497245, -0.027553677558898926, -0.033027805387973785, 0.0016209696186706424,
          -0.018809756264090538, -0.01136013213545084, 0.0824522003531456, -0.018729763105511665, 0.07456697523593903,
          -0.011320398189127445, 0.0037105248775333166, -0.039598558098077774, 0.007987743243575096,
          0.011225326918065548, -0.05905783921480179, -0.013708502054214478, -0.01931791752576828, 0.017379414290189743,
          -0.05886324495077133, -0.01902623474597931, 0.041046444326639175, 0.027321433648467064, 0.021785831078886986,
          0.021456340327858925, -0.03408118709921837, 0.001420145621523261, -0.05304862931370735, 0.021229317411780357,
          0.020764010027050972, -0.034095872193574905, 0.009326743893325329, -0.008019274100661278, 0.01599724590778351,
          0.0048420303501188755, 0.033370885998010635, 0.010972145944833755, -0.04460325464606285, -0.07033252716064453,
          -0.014535563066601753, 0.0018549764063209295, -0.043661538511514664, -0.045146871358156204,
          -0.029363753274083138, 0.034368593245744705, -0.07542362809181213, 0.10282149165868759, -0.053797729313373566,
          -0.017632169649004936, 0.02246987260878086, -0.017092477530241013, 0.06002878025174141, 0.015126933343708515,
          0.043482936918735504, 0.0257633775472641, -0.0325961709022522, -0.002118354896083474, 0.040822919458150864,
          0.013129092752933502, -0.011630954220890999, 0.011997123248875141, -0.017553087323904037, 0.05165039747953415,
          0.006244027521461248, 0.013711960054934025, -0.07752855122089386, 0.02794104814529419, -0.0034637916833162308,
          -0.025263337418437004, -0.12890850007534027, 0.07908573746681213, 0.0357125848531723, 0.003272172762081027,
          -0.000296828307909891, -0.09748417884111404, 0.018891237676143646, -0.006212838925421238,
          -0.010747136548161507, 0.04661891236901283, -0.017775606364011765, -0.05224284157156944, 0.051972709596157074,
          0.007478287909179926, -0.040386661887168884, 0.07169383019208908, 0.20449349284172058, -0.016739407554268837,
          0.02028394490480423, -0.016169002279639244, -0.018396791070699692, 0.04778747260570526, -0.03242383152246475,
          -0.08936547487974167, -0.0519343838095665, 0.03209693729877472, 0.03607682138681412, -0.048309121280908585,
          0.0363786444067955, 0.018490148708224297, 0.07142207026481628, -0.035155776888132095, -0.054069600999355316,
          -0.03110315650701523, 0.008652908727526665, -0.0269706342369318, 0.025618379935622215, -0.03383718058466911,
          0.04713258519768715, 0.004278168547898531, 0.010614640079438686, 0.010279934853315353, -0.04073033109307289,
          -0.04942809045314789, -4.1731338824557265e-33, 0.07678111642599106, -0.09149770438671112, 0.04890768975019455,
          -0.07181365042924881, 0.017333360388875008, 0.036177635192871094, -0.026246806606650352,
          -0.016154486685991287, -0.0032105064019560814, 0.06802214682102203, -0.10421232134103775,
          -0.03310611471533775, -0.04544730484485626, -0.06374529004096985, 0.06444627046585083, 0.03911610692739487,
          -0.0313982293009758, 0.10810865461826324, -0.04983404651284218, 0.005936998408287764, -0.08272314816713333,
          0.11149263381958008, 0.019507460296154022, 0.040353864431381226, -0.013326894491910934, -0.020374879240989685,
          -0.03176369145512581, -0.04689352586865425, -0.0029166487511247396, 0.01714232750236988, 0.06386785209178925,
          -0.08822084218263626, -0.057249683886766434, 0.015144187025725842, 0.04761763662099838, -0.08869273960590363,
          -0.014812277629971504, -0.09877648204565048, 0.005203298758715391, 0.03858598694205284, 0.03583536669611931,
          0.002139196265488863, -0.0450071319937706, 4.167268343735486e-05, -0.005259934812784195, 0.05159890279173851,
          0.1441488265991211, 0.042793773114681244, -0.03930414095520973, 0.07918673753738403, -0.07082842290401459,
          0.012476520612835884, -0.06993593275547028, -0.04721999168395996, -0.0069366213865578175,
          -0.06078223139047623, 0.050688620656728745, -0.024887997657060623, -0.029444949701428413,
          -0.02052515558898449, 0.02399432472884655, 0.07384216785430908, 0.042321063578128815, -0.10487231612205505,
          0.09150075167417526, -0.0026876702904701233, -0.011208876967430115, -0.006803592666983604, 0.0364672914147377,
          -0.05280909687280655, 0.018057052046060562, -0.1142544373869896, 0.000877177866641432, -0.033494140952825546,
          0.015568520873785019, -0.0038512584287673235, 0.07825524359941483, -0.019595805555582047,
          -0.06870308518409729, 0.02091679535806179, 0.04559963196516037, -0.0470348559319973, 0.00528583163395524,
          -0.0233780350536108, 0.013235626742243767, 0.0844450294971466, -0.04060767590999603, -0.07625975459814072,
          0.10404153913259506, 0.05752037093043327, -0.06096635386347771, -0.047521986067295074, 0.013274186290800571,
          -0.10895184427499771, -0.03666047006845474, 4.370466690522156e-33, 0.0021821032278239727,
          -0.013215389102697372, -0.008860004134476185, 0.060952309519052505, 0.02773408591747284,
          -0.012975160963833332, -0.09645765274763107, 0.01897188276052475, -0.04225276783108711, -0.049268387258052826,
          -0.019449444487690926, 0.006674375385046005, 0.06824047118425369, -0.04507140442728996, 0.043535880744457245,
          -0.017297934740781784, 0.07264556735754013, -0.03394446521997452, 0.06391505151987076, 0.01815587654709816,
          -0.03284003958106041, -0.05517428368330002, -0.05557931959629059, 0.017225466668605804, -0.02766478806734085,
          0.06584043800830841, -0.0032553451601415873, -0.059328366070985794, 0.010538917034864426, 0.03882242739200592,
          -0.011414955370128155, 0.03242605924606323, 0.022776851430535316, 0.025001617148518562, 0.03448951616883278,
          0.040402453392744064, -0.029939092695713043, -0.009423774667084217, -0.005662212613970041,
          -0.04789663851261139, 0.07718206942081451, 0.07589798420667648, -0.015941036865115166, 0.13240401446819305,
          -0.0025670169852674007, -0.025140825659036636, -0.017055075615644455, 0.127009779214859, 0.014378165826201439,
          0.014789038337767124, -0.08421158790588379, 0.033332668244838715, 0.05141555145382881, -0.1328931748867035,
          0.035740189254283905, -0.03235643357038498, -0.022529931738972664, -0.028053106740117073, 0.07638553529977798,
          0.046339258551597595, -0.00779727241024375, -0.010490489192306995, -0.0378652960062027, 0.055151864886283875,
          -0.03925371542572975, 0.09087816625833511, -0.05237775668501854, 0.08290370553731918, -0.0629241093993187,
          0.03793005272746086, 0.04968353733420372, 0.013882922939956188, 0.0204586461186409, -0.031952667981386185,
          -0.0752822756767273, 0.04516419395804405, -0.05529109388589859, 0.020149413496255875, 0.0487242229282856,
          0.006005407311022282, 0.03828344866633415, -0.041315194219350815, 0.04900309443473816, 0.06120583042502403,
          -0.0693698599934578, 0.06305398046970367, 0.05863158404827118, -0.01811523549258709, -0.02306249365210533,
          -0.0016203405102714896, -0.011120735667645931, -0.0030656345188617706, 0.04550841823220253,
          0.07977095246315002, -0.0061389305628836155, -1.1421673384859332e-08, 0.10410840064287186,
          0.04285211116075516, 0.06940940767526627, -0.04951831325888634, 0.07506196200847626, 0.0063189794309437275,
          0.0672224834561348, 0.12340927124023438, -0.027504151687026024, 0.030087878927588463, -0.006023129913955927,
          0.01800641417503357, 0.12391878664493561, 0.06750798970460892, 0.10055819898843765, 0.050359707325696945,
          0.016200508922338486, -0.04646646976470947, -0.05578671395778656, 0.01860075257718563, -0.08067420870065689,
          -0.003463521134108305, 0.003219784004613757, -0.03071908839046955, -0.06237545982003212, 0.024532951414585114,
          0.04488718509674072, 0.09935026615858078, 0.06867896765470505, 0.03781869634985924, 0.006253628060221672,
          -6.389572081388906e-05, -0.08207132667303085, -0.021352384239435196, 0.004807418677955866,
          -0.021696479991078377, -0.06511638313531876, -0.017695214599370956, 0.021736271679401398,
          -0.11510364711284637, -0.010250721126794815, 0.08569587767124176, 0.06527231633663177, 0.014868362806737423,
          -0.03424004465341568, 0.006471109110862017, 0.05059070512652397, -0.024139245972037315, -0.08673369884490967,
          -0.026187501847743988, 0.023637058213353157, 0.01561795175075531, 0.04986777901649475, 0.011696449480950832,
          0.016205642372369766, -0.05710950493812561, 0.03868356719613075, 0.08355355262756348, -0.10529405623674393,
          0.03461340442299843, 0.07030422985553741, 0.015384155325591564, 0.11001569032669067, -0.020884772762656212]

# define pipeline
pipeline = [
    {
        '$vectorSearch': {
            'index': os.getenv("INDEX_NAME"),
            'path': os.getenv("EMBEDDING_KEY"),
            'queryVector': vector,
            'numCandidates': 150,
            'limit': 10,
            'filter': {'$and': [{'year': {'$gt': '1990'}}, {'year': {'$lt': '2005'}}]}
        }
    },
    {'$set': {'score': {'$meta': 'vectorSearchScore'}}}
]

pipeline = [
    {
        '$vectorSearch': {
            'index': 'movies_vector_index',
            'path': 'embedding',
            'queryVector': vector,
            'numCandidates': 40,
            'limit': 4,
            'filter': {
                '$and': [{'year': {'$gt': {'date': '1990-01-01', 'type': 'date'}}},
                         {'year': {'$lt': {'date': '2005-12-31', 'type': 'date'}}}]
            }
        }
    },
    {'$set': {'score': {'$meta': 'vectorSearchScore'}}}
]

# run pipeline
result = collection.aggregate(pipeline)

# print results
for i in result:
    print(i)

# {'$vectorSearch': {'queryVector': , 'path': 'embedding', 'numCandidates': 40, 'limit': 4, 'index': 'default', 'filter': {'$and': [{'year': {'$gt': '1990'}}, {'year': {'$lt': '2005'}}, {'genre': {'$eq': 'animated'}}]}}}, {'$set': {'score': {'$meta': 'vectorSearchScore'}}}
